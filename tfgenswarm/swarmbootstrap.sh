#!/bin/bash
# Master Bootstrap
apt-get update
apt-get install -y \
  apt-transport-https \
  ca-certificates \
  curl \
  software-properties-common \
  jq \
  etcd

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs) stable"
apt-get update
apt-get install -y docker-ce

echo '
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379,http://0.0.0.0:4001"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://0.0.0.0:2380,http://0.0.0.0:7001"
ETCD_ADVERTISE_CLIENT_URLS="http://0.0.0.0:2379,http://0.0.0.0:4001"
' >> /etc/default/etcd

## need to write workerinfo and master info to etcd cluster.
service etcd restart

#initialize docker swarm.
docker swarm init

#write worker and manager tokens to etcd.
etcdctl set worker-token $(docker swarm join-token worker|grep token|awk '{ print $5 }')
etcdctl set manager-token $(docker swarm join-token manager|grep token|awk '{ print $5 }')

echo 'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4gICQgIC4KICAgICAgICAuLi4uICAgICAgICAgICAgIGQgICogICogICQgICAgLgogICAuemUkJCQkJCQkJGJlLi4gICAgICAgXmIgXkwgNEYgJCAgICAkCiAgZSQkJCQkJCQkJCQkJCQkJCRlICAgICAgIkwgJCAgYiAkICAgSiUKLiQkJCQkJCQkJCQkJCRQKioiIioqICAgICAgM3InTCAkICQgIDRGCiAiKiQkJCQkJCQkKiIgICAgICAgICAgICAgICAqLiQgMyAkICAkCiAgICokJCQkJCIgICAgICAgICAgICAgICAgICBeJCdyJyRQIGQiCiAgIF4kJCQiICAgICAgICAgICAgICAgICAgICAgXiQkICRGNEYKICAgICQkJCAgICAgICAgICAgICAgICAgICAgICAgIiRyKmJQCiAgICAkJCRGICAgICAgICAgICAgICAgICAgICAgICAgIjQkIgogICAgJCQkJCAgICAgICAgICAgICAgICAgICAgICAgICBeIgogICAgJCQkJGIgICAgICAgICAgICAgIC4uZWVlZWQkJCQkJCQkJGVlZWUuLi4KICAgICokJCQkYi4gICAgICAgLnplJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGJlLi4KICAgICckJCQkJCRiZWUuLmUkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCRiYwogICAgIDMkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGMKICAgICAgIiokJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkcgogICAgICAgIF4iIiIiJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkZS4uICAgICAgICBQCiAgICAgICAgICAgICAiJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGJlZS56QCIKICAgICAgICAgICAgICBeKiQkJCQkJCQkKiIiIiAgICAgIiIiIioqJCQkJCQkJCQkJCQkJCIKICAgICAgICAgICAgICAgIF4iKiQkJCIgICAgICAgICAgICAgICAgICIiKiQkJCQkJCoiCiAgICAgICAgICAgICAgICAgICAgIiIqKmVlZWMuLi4uLi4uLi4uLi5lZWVAKioiIiAgIEdpbG85NCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIiIiIiIiIiIiIiIiIiIK' |base64 -di > /etc/motd
echo 'IyNyb290QHN3YXJtLXN3YXJtY2x1c3Rlci1ub2RlMTA6L2V0Yy9zeXN0ZW1kL3N5c3RlbSMgY2F0IGRvY2tlci10bHMuc2VydmljZSAKW1VuaXRdCkRlc2NyaXB0aW9uPURvY2tlciBBcHBsaWNhdGlvbiBDb250YWluZXIgRW5naW5lCkRvY3VtZW50YXRpb249aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20KQWZ0ZXI9bmV0d29yay1vbmxpbmUudGFyZ2V0IGRvY2tlci5zb2NrZXQgZmlyZXdhbGxkLnNlcnZpY2UKV2FudHM9bmV0d29yay1vbmxpbmUudGFyZ2V0CgpbU2VydmljZV0KVHlwZT1ub3RpZnkKIyB0aGUgZGVmYXVsdCBpcyBub3QgdG8gdXNlIHN5c3RlbWQgZm9yIGNncm91cHMgYmVjYXVzZSB0aGUgZGVsZWdhdGUgaXNzdWVzIHN0aWxsCiMgZXhpc3RzIGFuZCBzeXN0ZW1kIGN1cnJlbnRseSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBjZ3JvdXAgZmVhdHVyZSBzZXQgcmVxdWlyZWQKIyBmb3IgY29udGFpbmVycyBydW4gYnkgZG9ja2VyCkV4ZWNTdGFydD0vdXNyL2Jpbi9kb2NrZXJkIC0tdGxzdmVyaWZ5IC0tdGxzY2FjZXJ0PS9ldGMvc3NsL2NlcnRzL2NhLnBlbSAtLXRsc2NlcnQ9L2V0Yy9zc2wvY2VydHMvc3dhcm1zZXJ2ZXIucGVtIC0tdGxza2V5PS9ldGMvc3NsL3ByaXZhdGUvc3dhcm1zZXJ2ZXIta2V5LnBlbSAtSD0wLjAuMC4wOjIzNzYgCkV4ZWNSZWxvYWQ9L2Jpbi9raWxsIC1zIEhVUCAkTUFJTlBJRApMaW1pdE5PRklMRT0xMDQ4NTc2CiMgSGF2aW5nIG5vbi16ZXJvIExpbWl0KnMgY2F1c2VzIHBlcmZvcm1hbmNlIHByb2JsZW1zIGR1ZSB0byBhY2NvdW50aW5nIG92ZXJoZWFkCiMgaW4gdGhlIGtlcm5lbC4gV2UgcmVjb21tZW5kIHVzaW5nIGNncm91cHMgdG8gZG8gY29udGFpbmVyLWxvY2FsIGFjY291bnRpbmcuCkxpbWl0TlBST0M9aW5maW5pdHkKTGltaXRDT1JFPWluZmluaXR5CiMgVW5jb21tZW50IFRhc2tzTWF4IGlmIHlvdXIgc3lzdGVtZCB2ZXJzaW9uIHN1cHBvcnRzIGl0LgojIE9ubHkgc3lzdGVtZCAyMjYgYW5kIGFib3ZlIHN1cHBvcnQgdGhpcyB2ZXJzaW9uLgpUYXNrc01heD1pbmZpbml0eQpUaW1lb3V0U3RhcnRTZWM9MAojIHNldCBkZWxlZ2F0ZSB5ZXMgc28gdGhhdCBzeXN0ZW1kIGRvZXMgbm90IHJlc2V0IHRoZSBjZ3JvdXBzIG9mIGRvY2tlciBjb250YWluZXJzCkRlbGVnYXRlPXllcwojIGtpbGwgb25seSB0aGUgZG9ja2VyIHByb2Nlc3MsIG5vdCBhbGwgcHJvY2Vzc2VzIGluIHRoZSBjZ3JvdXAKS2lsbE1vZGU9cHJvY2VzcwojIHJlc3RhcnQgdGhlIGRvY2tlciBwcm9jZXNzIGlmIGl0IGV4aXRzIHByZW1hdHVyZWx5ClJlc3RhcnQ9b24tZmFpbHVyZQpTdGFydExpbWl0QnVyc3Q9MwpTdGFydExpbWl0SW50ZXJ2YWw9NjBzCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKCg==' | base64 -di > /etc/systemd/system/docker-tls.service

echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMrVENDQWVHZ0F3SUJBZ0lKQU1NaTlNRnhQcUtpTUEwR0NTcUdTSWIzRFFFQkN3VUFNQk14RVRBUEJnTlYKQkFNTUNITjNZWEp0TFdOaE1CNFhEVEUzTVRBeU9URXhNREF6TjFvWERUUTFNRE14TmpFeE1EQXpOMW93RXpFUgpNQThHQTFVRUF3d0ljM2RoY20wdFkyRXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRREF1alNsNTUwdGVHOGJvWmhFUnQ1ZWZtN0tNd2RpMXZsampkMERLdkUxZ3VDU09oQTY5NWRQWkh0YmsrL0MKaHZ1akY4M01TSmlIOUpuYWtMWHl2YWdMTDgrVFUyQTRKYkJyaDAzQ2paM3F1WDZnQ3c0VldGcm9tcUZFcDNqUApzOXcwdWtrSllhdXFBR3hEQzhucjZydE9wTlo4cWltL1FIOXljVnNSTnczWkN2dmt5VmtLRHRuTS8zbDZOb0o5CmFYWHVUbDA1YStyLytkYm0wekhKcUlyVG5heGRjUWIzcWEzOGRSYlNLZTJ5K3NaUURqcmVQVHpkMkZnUHpNMG0KZzZ1VzRKZEw4UXJzOTIram4xdStYWHQ1ZDY1N3QyYkVHbFE2S0hRZUNaUklvM3B5R3pMUEVsWGNHQm9wTUtuVwpiVkRiSjRpL0xsZGtvVEZFaXhBcXEzL0ZBZ01CQUFHalVEQk9NQjBHQTFVZERnUVdCQlNWNUlFbkYzMFlZZ05jCi9oY0FTMnhMVnRHZ0lqQWZCZ05WSFNNRUdEQVdnQlNWNUlFbkYzMFlZZ05jL2hjQVMyeExWdEdnSWpBTUJnTlYKSFJNRUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFDLzJZTmozYlkvLzlib3V4U1c5anRxM1FjUApBNm5KbTRJUXliRGZOSGl2UWZLUWl1Mi9tS0hWRjNDbGdlS05BQ2gybSsyZUN0R0JmaURjeE9mL0ZlMUloMmFmCmhCbzVIdWl2RTBORlpCemRuZE5yZW80WGJuYlplZkFxa2pNT0lJWmMvZXN5cWswUEpqMHdXYktRUS91OFVaN2sKQ041bCtVZzBRMFQyMWFCQ0VHMHlialc5K015UTEvYVhibFhyMWNMUFFhM1pYeGo4QS9GOTdnK0Qxb2NibHJVVApIdUhzdWQ1Umw2bUxoUWF3blV5ZmRYL2RER1Z6SVRsZHdtOTNvVGFKalcyQXVTRjJmY0JZVlhKdnpQRzdvWit3CmtMTnpHTGc1Y3pHV3NrQzdjTkp1VTk3anhFTVJJMTFwL3V6N0lITXlRcTVPOE11MzJKTU9Zb013RXB3NAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==" | base64 -di  >/etc/ssl/certs/ca.pem
echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURTRENDQWpDZ0F3SUJBZ0lKQUtnUmhkTnQwWWpyTUEwR0NTcUdTSWIzRFFFQkN3VUFNQk14RVRBUEJnTlYKQkFNTUNITjNZWEp0TFdOaE1CNFhEVEUzTVRBeU9URXhNREF6TjFvWERURTRNVEF5T1RFeE1EQXpOMW93RmpFVQpNQklHQTFVRUF3d0xjM2RoY20xelpYSjJaWEl3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUR6ZldERDVhdWdFRUttVzVYQUppU0d0UVgyT3RUMlpHdVlkUTlocTNMRVM3ZFN4cUNCSEJqZGFOUUwKREl3dkluV2JkVmt5SUJ2VHRkQXFzN2lPT242SW03TXZPblNmcE0zMlB1ZThYUXhuU0ZiZnlNRnVvQVFVTm5vSwpJcTY0bFBpaUFsZ1k1eEZ3dWhyK252Nmx2dm5GejdUSTRGZGlyQ29iMUFDTVozMFY2cytDdmZnTHhtUVhQM2JECnNmeTdPeFFKdjJZb1JYMTBsMUxkODM1cER5ZW5DQThXZlFzczN3TWFudGxiQjVNbHZtQkxnVm55TGtxYnNaUnEKQk1YRTN3MjJYYnRnaExnTGdJUUFyKyt5R1NsMWowcVdnVC9zTU9RYzZzVGdjZll0RzVmMEVLNUFhY244dzA3QQpWNVRia2NWQWkvSTJwTHFycHoyUE16YTJydHliQWdNQkFBR2pnWnN3Z1pnd0NRWURWUjBUQkFJd0FEQUxCZ05WCkhROEVCQU1DQmVBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNRjhHQTFVZEVRUlkKTUZhQ0JYTjNZWEp0Z2cxemQyRnliUzVrWldaaGRXeDBnaEZ6ZDJGeWJTNWtaV1poZFd4MExuTjJZNElmYzNkaApjbTB1WkdWbVlYVnNkQzV6ZG1NdVkyeDFjM1JsY2k1c2IyTmhiSWNFZndBQUFZY0Vmd0FBQVRBTkJna3Foa2lHCjl3MEJBUXNGQUFPQ0FRRUFmRnNEZkwxSzR0TnFzWWxEUVFpa2g4VHIrMXpEUG9kcExaeHlpMENyU1FDWW5UQ3EKVlhpa3phaWNqRm1kNlBNL1lJZFVIQXpZeDRrQlpDRm5nWjZjb2YzMS9yOS80ZElJNXU5YjVGUnRBdHVCOVl5MwpWdzBKYmFuRjdqaHhETWI5N1dZdS8zVHpQdk9OS0trYmhiUFlmMUxrQzlUWUtkS3hxOWlxSTVuNSsxUjA0NGRaCnI5dlk1UXIxaEpJeVM1bzBKV1U3TlBqQjIyeE1BNTA5eERqU1BHR1Q1bG84dExkcUNQQlMvVVJXWURmazhNM3YKY2YzMmxIMnNtUHBubml2cmFvTldFK0puaDNnWFpZUDVZVi9jTExuWEJHSzduT2dTUnFCV29MWS9ESHFBMWpJYgo3Tnh5RGpZVkNBTXFhMWtiRkJ1QVBYcFBxaUFKbUhDYndLVkJEZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K" | base64 -di > /etc/ssl/certs/swarmserver.pem
echo "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcFFJQkFBS0NBUUVBODMxZ3crV3JvQkJDcGx1VndDWWtoclVGOWpyVTltUnJtSFVQWWF0eXhFdTNVc2FnCmdSd1kzV2pVQ3d5TUx5SjFtM1ZaTWlBYjA3WFFLck80ampwK2lKdXpMenAwbjZUTjlqN252RjBNWjBoVzM4akIKYnFBRUZEWjZDaUt1dUpUNG9nSllHT2NSY0xvYS9wNytwYjc1eGMrMHlPQlhZcXdxRzlRQWpHZDlGZXJQZ3IzNApDOFprRno5Mnc3SDh1enNVQ2I5bUtFVjlkSmRTM2ZOK2FROG5wd2dQRm4wTExOOERHcDdaV3dlVEpiNWdTNEZaCjhpNUttN0dVYWdURnhOOE50bDI3WUlTNEM0Q0VBSy92c2hrcGRZOUtsb0UvN0REa0hPckU0SEgyTFJ1WDlCQ3UKUUduSi9NTk93RmVVMjVIRlFJdnlOcVM2cTZjOWp6TTJ0cTdjbXdJREFRQUJBb0lCQVFDOFhMTGQrUytpL05GQwp0cmtMVTdhUUN6eFlkcnpHKzNxTkQ0bmRxZTkzMFljNVh2Vk55L21rVnZNcXRRTkJkMnY1M25jcEl0UEVIUE8wCkJTSnh6T2lVTDdjWGd5WXpWaUFMTGpEQmRFNGpIRUF3a0xLckxOamE5aVhFNzMyd3gzWHNodG0yTWhNNDNKQUQKaCtaQlBKTW5KdjZaSTR3V2hrOXhCYm1DNUpCTXdiNkoyMUxmN1dENXp1QUZnZFpvZWpUSXVaVGoxaTliMDJEawo4KzAxVHY3SlV6QUI2QmNlSFNRa2l0M3B3ZTUwV2pKcEVzQm1ZSkhEaE1UVDZjcWdqeFdjUEVJY2JPMVk2ek5OCmd0bGtiMFVJeXd4M0hmS2hZU0JqMlZoQ20vQmNTN0FhcWRNV1JEdFFtTDU2eXo4YkhHR0NyY2xQbFEzdzdScUoKTE05VWh3RGhBb0dCQVByUGVnbkRnQ3JUd0RZRlhjUGtQbzhrMUpZK3JXS1hJNXdUQk95RjgzR1JvU2tSUFBVbApDelEvaWRJa1k0eHFZM2tNTk53MHJSSXpjNkZnVXJ3SWZpc0hnSVA4VExPQy9xU0NaVGNHcXo1SXk4bWp4N01jCjRmR0ZNZWQ4SkFuVWh4UGFnNnUvYnBTVGxGR0dvdHE5RVpTZmJjKzk4SmNjMWVZZjR3RkI1U2dSQW9HQkFQaUgKSDhYNHZCZXdid3phazN0QXllTXF3a0hhOXpSY0JaWjhJd1JyOU5DdjlGTmo1cWt3aE80T3hKR1BIZ1RhSDNaKwpHajlGK3ZpU2RtUFJhcXE5VXZ2TllOemg1ZjhLVGY2SWs2YUZTR1RsUmhNMzlkRG1RUTdRWGlRNjd2NlduZStxClpMdGVCeFQ0SXhlbGNRai96RUdVZGwrRnBMbTNvY09BT05lM25zWHJBb0dCQUtEa0lYeEw3bGNLMlQyT09iVWwKSU1DQXR1TGV1Q2tMbld0TWhCY2FZcTJTNXhoS0Y1bUd0dVpBY0MvZTZnRTBhalZIa0UxR2VWTzRyODl3MUFJTgpUS3BidUtSeVg5MjBCWmdRa2M4M3R2aFFpSElFWDJIV0FGY0h3NWlrZVJYWlFRR0tabmJ4YVlWa0dud2w2eWg0CnF1TjFWbU15akRqVDVaOG5DMTlPSHl1UkFvR0JBTXlyMjByYXNXeUE3TE9WUG1mK3owUzU3Z2oySHllTHNUNWgKTlNWckVzN2FXVWhqdVk0VVd5VUNISGdUZVJGZDRSTmdmcFVsT0s2RlQrS2NrRS9VWXdiaitLVnZsRTRaV21vSQphREIzQzB1c1ZhMTJKSWJKV1VLdDd4bS9QeHVEUnNZZGVaK2tyQWhrNGVHVGFpZVRJYy9RU0R3YWY3SkN2SUdZCmt6ZDBETm5KQW9HQVdrNXNKMzYvYm5MVTFoaENPeGdmbmN3dFZNL2pkeDlsZXgwbitFU1BNMXpVZnMyY1FwVzMKME9yQjV5YTU4bXorMlJid2xpOWpOdjJobUlmc0h5T0ZyYWpxUjV6dmQzOVZYdkR4SVRqZzRpN3RSdWJLRlhobApscUZNZFBCUG9NMnU5RWlWQzBYU2o0NkRaQWFTK2NHSzlhK3E2WjNiWWxMcWNaeFJYeVI3L2J3PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=" | base64 -di  > /etc/ssl/private/swarmserver-key.pem

systemctl daemon-reload
systemctl stop docker && systemctl disable docker
systemctl start docker-tls
