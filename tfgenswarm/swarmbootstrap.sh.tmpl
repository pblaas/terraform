#!/bin/bash
# Master Bootstrap
apt-get update
apt-get install -y \
  apt-transport-https \
  ca-certificates \
  curl \
  software-properties-common \
  jq \
  etcd

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs) stable"
apt-get update
apt-get install -y docker-ce

echo '
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379,http://0.0.0.0:4001"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://0.0.0.0:2380,http://0.0.0.0:7001"
ETCD_ADVERTISE_CLIENT_URLS="http://0.0.0.0:2379,http://0.0.0.0:4001"
' >> /etc/default/etcd

## need to write workerinfo and master info to etcd cluster.
service etcd restart

#initialize docker swarm.
docker swarm init

#write worker and manager tokens to etcd.
etcdctl set worker-token $(docker swarm join-token worker|grep token|awk '{ print $5 }')
etcdctl set manager-token $(docker swarm join-token manager|grep token|awk '{ print $5 }')

echo 'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4gICQgIC4KICAgICAgICAuLi4uICAgICAgICAgICAgIGQgICogICogICQgICAgLgogICAuemUkJCQkJCQkJGJlLi4gICAgICAgXmIgXkwgNEYgJCAgICAkCiAgZSQkJCQkJCQkJCQkJCQkJCRlICAgICAgIkwgJCAgYiAkICAgSiUKLiQkJCQkJCQkJCQkJCRQKioiIioqICAgICAgM3InTCAkICQgIDRGCiAiKiQkJCQkJCQkKiIgICAgICAgICAgICAgICAqLiQgMyAkICAkCiAgICokJCQkJCIgICAgICAgICAgICAgICAgICBeJCdyJyRQIGQiCiAgIF4kJCQiICAgICAgICAgICAgICAgICAgICAgXiQkICRGNEYKICAgICQkJCAgICAgICAgICAgICAgICAgICAgICAgIiRyKmJQCiAgICAkJCRGICAgICAgICAgICAgICAgICAgICAgICAgIjQkIgogICAgJCQkJCAgICAgICAgICAgICAgICAgICAgICAgICBeIgogICAgJCQkJGIgICAgICAgICAgICAgIC4uZWVlZWQkJCQkJCQkJGVlZWUuLi4KICAgICokJCQkYi4gICAgICAgLnplJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGJlLi4KICAgICckJCQkJCRiZWUuLmUkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCRiYwogICAgIDMkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGMKICAgICAgIiokJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkcgogICAgICAgIF4iIiIiJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkZS4uICAgICAgICBQCiAgICAgICAgICAgICAiJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJGJlZS56QCIKICAgICAgICAgICAgICBeKiQkJCQkJCQkKiIiIiAgICAgIiIiIioqJCQkJCQkJCQkJCQkJCIKICAgICAgICAgICAgICAgIF4iKiQkJCIgICAgICAgICAgICAgICAgICIiKiQkJCQkJCoiCiAgICAgICAgICAgICAgICAgICAgIiIqKmVlZWMuLi4uLi4uLi4uLi5lZWVAKioiIiAgIEdpbG85NCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIiIiIiIiIiIiIiIiIiIK' |base64 -di > /etc/motd
echo 'IyNyb290QHN3YXJtLXN3YXJtY2x1c3Rlci1ub2RlMTA6L2V0Yy9zeXN0ZW1kL3N5c3RlbSMgY2F0IGRvY2tlci10bHMuc2VydmljZSAKW1VuaXRdCkRlc2NyaXB0aW9uPURvY2tlciBBcHBsaWNhdGlvbiBDb250YWluZXIgRW5naW5lCkRvY3VtZW50YXRpb249aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20KQWZ0ZXI9bmV0d29yay1vbmxpbmUudGFyZ2V0IGRvY2tlci5zb2NrZXQgZmlyZXdhbGxkLnNlcnZpY2UKV2FudHM9bmV0d29yay1vbmxpbmUudGFyZ2V0CgpbU2VydmljZV0KVHlwZT1ub3RpZnkKIyB0aGUgZGVmYXVsdCBpcyBub3QgdG8gdXNlIHN5c3RlbWQgZm9yIGNncm91cHMgYmVjYXVzZSB0aGUgZGVsZWdhdGUgaXNzdWVzIHN0aWxsCiMgZXhpc3RzIGFuZCBzeXN0ZW1kIGN1cnJlbnRseSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBjZ3JvdXAgZmVhdHVyZSBzZXQgcmVxdWlyZWQKIyBmb3IgY29udGFpbmVycyBydW4gYnkgZG9ja2VyCkV4ZWNTdGFydD0vdXNyL2Jpbi9kb2NrZXJkIC0tdGxzdmVyaWZ5IC0tdGxzY2FjZXJ0PS9ldGMvc3NsL2NlcnRzL2NhLnBlbSAtLXRsc2NlcnQ9L2V0Yy9zc2wvY2VydHMvc3dhcm1zZXJ2ZXIucGVtIC0tdGxza2V5PS9ldGMvc3NsL3ByaXZhdGUvc3dhcm1zZXJ2ZXIta2V5LnBlbSAtSD0wLjAuMC4wOjIzNzYgLUggdW5peDovLy92YXIvcnVuL2RvY2tlci5zb2NrIApFeGVjUmVsb2FkPS9iaW4va2lsbCAtcyBIVVAgJE1BSU5QSUQKTGltaXROT0ZJTEU9MTA0ODU3NgojIEhhdmluZyBub24temVybyBMaW1pdCpzIGNhdXNlcyBwZXJmb3JtYW5jZSBwcm9ibGVtcyBkdWUgdG8gYWNjb3VudGluZyBvdmVyaGVhZAojIGluIHRoZSBrZXJuZWwuIFdlIHJlY29tbWVuZCB1c2luZyBjZ3JvdXBzIHRvIGRvIGNvbnRhaW5lci1sb2NhbCBhY2NvdW50aW5nLgpMaW1pdE5QUk9DPWluZmluaXR5CkxpbWl0Q09SRT1pbmZpbml0eQojIFVuY29tbWVudCBUYXNrc01heCBpZiB5b3VyIHN5c3RlbWQgdmVyc2lvbiBzdXBwb3J0cyBpdC4KIyBPbmx5IHN5c3RlbWQgMjI2IGFuZCBhYm92ZSBzdXBwb3J0IHRoaXMgdmVyc2lvbi4KVGFza3NNYXg9aW5maW5pdHkKVGltZW91dFN0YXJ0U2VjPTAKIyBzZXQgZGVsZWdhdGUgeWVzIHNvIHRoYXQgc3lzdGVtZCBkb2VzIG5vdCByZXNldCB0aGUgY2dyb3VwcyBvZiBkb2NrZXIgY29udGFpbmVycwpEZWxlZ2F0ZT15ZXMKIyBraWxsIG9ubHkgdGhlIGRvY2tlciBwcm9jZXNzLCBub3QgYWxsIHByb2Nlc3NlcyBpbiB0aGUgY2dyb3VwCktpbGxNb2RlPXByb2Nlc3MKIyByZXN0YXJ0IHRoZSBkb2NrZXIgcHJvY2VzcyBpZiBpdCBleGl0cyBwcmVtYXR1cmVseQpSZXN0YXJ0PW9uLWZhaWx1cmUKU3RhcnRMaW1pdEJ1cnN0PTMKU3RhcnRMaW1pdEludGVydmFsPTYwcwoKW0luc3RhbGxdCldhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0Cgo=' | base64 -di > /etc/systemd/system/docker-tls.service

echo "{{ CAPEM }}" | base64 -di  >/etc/ssl/certs/ca.pem
echo "{{ SWARMCERT }}" | base64 -di > /etc/ssl/certs/swarmserver.pem
echo "{{ SWARMKEY }}" | base64 -di  > /etc/ssl/private/swarmserver-key.pem
echo "{{ REXRAYINSTALL }}" | base64 -di  > /root/rexray_install.sh

sed -i "s/{{ olddns }}/{{ dnsserver }}/g" /etc/resolv.conf

#installing rexray pluging
sh /root/rexray_install.sh
systemctl daemon-reload
systemctl stop docker && systemctl disable docker
systemctl start docker-tls

